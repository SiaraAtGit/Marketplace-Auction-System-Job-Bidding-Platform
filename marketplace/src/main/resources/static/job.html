<!doctype html>
<html>
<head>
    <title>Job Details</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .winner { color: green; font-weight: bold; }
        .bid-status { color: blue; }
    </style>
</head>
<body>
<h1>Job Details</h1>
<a href="/index.html">Back to Home</a>

<div>
    <h2 id="jobDescription"></h2>
    <p><strong>Requirements:</strong> <span id="jobRequirements"></span></p>
    <p><strong>Poster:</strong> <span id="jobPoster"></span> (<span id="jobContact"></span>)</p>
    <p><strong>Expires At:</strong> <span id="jobExpires"></span></p>
    <p><strong>Lowest Bid:</strong> <span id="lowestBid"></span></p>
    <p><strong>Number of Bids:</strong> <span id="bidCount"></span></p>
    <p><strong>Winner:</strong> <span id="jobWinner" class="winner">No winner yet</span></p>
</div>

<h3>Place a Bid</h3>
<form id="bidForm">
    <label>Bidder Name:</label><br>
    <input type="text" id="bidderName" required><br><br>

    <label>Amount:</label><br>
    <input type="number" id="bidAmount" required><br><br>

    <button type="submit">Place Bid</button>
</form>
<p id="bidStatus" class="bid-status"></p>

<script src="app.js"></script>
<script>
const urlParams = new URLSearchParams(window.location.search);
const jobId = urlParams.get('id');

async function loadJob() {
    try {
        const job = await fetchJSON(`/api/jobs/${jobId}`);

        document.getElementById('jobDescription').textContent = job.description;
        document.getElementById('jobRequirements').textContent = job.requirements;
        document.getElementById('jobPoster').textContent = job.posterName;
        document.getElementById('jobContact').textContent = job.posterContact;
        document.getElementById('jobExpires').textContent = new Date(job.expiresAt).toLocaleString();
        document.getElementById('bidCount').textContent = job.bids.length;

        // Show winner if present
        document.getElementById('jobWinner').textContent = job.winnerBid
            ? `${job.winnerBid.bidderName} (â‚¹${job.winnerBid.amount})`
            : "No winner yet";

        const lowest = job.bids.length > 0 
            ? Math.min(...job.bids.map(b => parseFloat(b.amount))) 
            : "No bids yet";

        document.getElementById('lowestBid').textContent = lowest;
    } catch (err) {
        console.error("Failed to load job:", err);
        document.getElementById('bidStatus').textContent = "Error loading job details!";
    }
}

// Submit bid
document.getElementById('bidForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const bid = {
        bidderName: document.getElementById('bidderName').value,
        amount: parseFloat(document.getElementById('bidAmount').value)
    };

    try {
        const res = await fetch(`/api/jobs/${jobId}/bids`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bid)
        });

        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(errorText || `HTTP error! status: ${res.status}`);
        }

        document.getElementById('bidStatus').textContent = "Bid placed successfully!";
        document.getElementById('bidForm').reset();
        loadJob(); // refresh job details including bids
    } catch (err) {
        document.getElementById('bidStatus').textContent = "Error placing bid: " + err.message;
        console.error(err);
    }
});

// Auto-refresh every 5 seconds
setInterval(loadJob, 5000);

loadJob();
</script>
</body>
</html>
